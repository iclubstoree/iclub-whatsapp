<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>CONTROLE ICLUB SA√çDAS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #8b5cf6;
      --secondary-color: #a855f7;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --dark-color: #1f2937;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --whatsapp-green: #25d366;
      --whatsapp-dark: #128c7e;
      --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --ai-color: #667eea;
    }

    body {
      background: #ffffff;
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .main-container {
      background: var(--white);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      margin: 20px auto;
      padding: 30px;
      max-width: 1400px;
    }

    .header-title {
      color: #10b981;
      font-weight: 800;
      font-size: 2rem;
      margin-bottom: 30px;
      text-align: center;
      position: relative;
    }

    /* ===== MODAL TREINAMENTO IA ===== */
    .modal-treinamento {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2001;
      backdrop-filter: blur(5px);
    }

    .modal-treinamento-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-treinamento-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-treinamento-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-treinamento-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-treinamento-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-treinamento-body {
      padding: 30px;
    }

    .treinamento-item {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .treinamento-input {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      width: 100%;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .treinamento-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn-analise-inteligente {
      background: var(--ai-gradient);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 25px;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-analise-inteligente:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      color: white;
    }

    .btn-analise-inteligente:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn-analise-inteligente:hover:before {
      left: 100%;
    }

    .header-actions {
      position: absolute;
      top: 0;
      right: 0;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* ===== MODAL AN√ÅLISE INTELIGENTE ===== */
    .modal-analise {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal-analise-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    .modal-analise-header {
      background: var(--ai-gradient);
      color: white;
      padding: 25px 30px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-analise-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-analise-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-analise-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-analise-body {
      padding: 30px;
    }

    .analise-loading {
      text-align: center;
      padding: 60px 20px;
    }

    .analise-loading .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--ai-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .analise-resultado {
      display: none;
    }

    .insight-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-color: var(--ai-color);
    }

    .insight-card.tipo-tendencia {
      border-left: 6px solid #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    .insight-card.tipo-alerta {
      border-left: 6px solid #ef4444;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .insight-card.tipo-oportunidade {
      border-left: 6px solid #10b981;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    }

    .insight-card.tipo-insight {
      border-left: 6px solid #8b5cf6;
      background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 100%);
    }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .insight-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
    }

    .insight-icon.tendencia { background: #3b82f6; }
    .insight-icon.alerta { background: #ef4444; }
    .insight-icon.oportunidade { background: #10b981; }
    .insight-icon.insight { background: #8b5cf6; }

    .insight-titulo {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--dark-color);
      margin: 0;
    }

    .insight-valor {
      font-size: 0.9rem;
      color: #6b7280;
      margin: 0;
    }

    .insight-descricao {
      color: #374151;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .insight-acoes {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .insight-acao {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 16px;
      color: #374151;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .insight-acao:hover {
      border-color: var(--ai-color);
      color: var(--ai-color);
      transform: translateY(-1px);
    }

    .resumo-executivo {
      background: var(--ai-gradient);
      color: white;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
      text-align: center;
    }

    .resumo-titulo {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .resumo-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .resumo-stat {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }

    .resumo-stat-valor {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .resumo-stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .progresso-analise {
      background: #f1f5f9;
      border-radius: 10px;
      height: 8px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progresso-barra {
      background: var(--ai-gradient);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    /* ===== EXISTING STYLES (mantidos iguais) ===== */
    .chat-ia-container {
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark));
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .chat-title {
      flex: 1;
    }

    .chat-title h5 {
      margin: 0;
      font-weight: 700;
      font-size: 1.3rem;
    }

    .chat-title small {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .chat-messages {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
      backdrop-filter: blur(10px);
    }

    .chat-message {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
    }

    .chat-message.user {
      justify-content: flex-end;
    }

    .chat-message.system {
      justify-content: flex-start;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      position: relative;
    }

    .chat-message.user .chat-bubble {
      background: #ffffff;
      color: var(--dark-color);
      border-bottom-right-radius: 6px;
    }

    .chat-message.system .chat-bubble {
      background: rgba(255,255,255,0.2);
      color: white;
      border-bottom-left-radius: 6px;
    }

    .chat-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 5px;
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 25px;
      padding: 12px 20px;
      color: white;
      font-size: 0.95rem;
    }

    .chat-input::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .chat-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.25);
    }

    .chat-send-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      color: white;
      font-size: 1.2rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-send-btn:hover:not(:disabled) {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chat-examples {
      margin-top: 15px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chat-example-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      padding: 6px 12px;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chat-example-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }

    .typing-indicator {
      display: none;
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border-radius: 18px;
      color: white;
      font-style: italic;
      align-items: center;
      gap: 8px;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .card-modern {
      background: var(--white);
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: none;
      padding: 25px;
      margin-bottom: 25px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card-modern:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .form-control, .form-select {
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      padding: 12px 16px;
      transition: all 0.2s ease;
      background: var(--light-bg);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--success-color);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      background: var(--white);
    }

    .btn-modern {
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
    }

    .btn-primary-modern {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .btn-primary-modern:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-success-modern {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
    }

    .btn-success-modern:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-sm-modern {
      padding: 8px 16px;
      font-size: 0.75rem;
      border-radius: 8px;
    }

    .status-section {
      background: var(--light-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .status-atrasadas { border-left-color: var(--danger-color); }
    .status-vencendo { border-left-color: var(--warning-color); }
    .status-proximas { border-left-color: #f97316; }
    .status-recorrentes { border-left-color: var(--success-color); }

    .status-title {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    .table-modern {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: none;
    }

    .table-modern thead {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
    }

    .table-modern th {
      border: none;
      padding: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      text-align: center;
    }

    .table-modern td {
      border: none;
      padding: 16px;
      vertical-align: middle;
      border-bottom: 1px solid #f1f5f9;
      text-align: center;
    }

    .table-modern tbody tr:hover {
      background: var(--light-bg);
      transition: background 0.2s ease;
    }

    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: var(--white);
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      box-shadow: var(--shadow);
      border: none;
      transition: transform 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, var(--success-color), #059669);
    }

    .dashboard-card:hover {
      transform: translateY(-3px);
    }

    .dashboard-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--dark-color);
      margin-bottom: 5px;
    }

    .dashboard-label {
      color: var(--success-color);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chart-container {
      background: var(--white);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--success-color);
      margin-bottom: 20px;
      text-align: center;
    }

    .editor-categoria {
      background: var(--light-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      border: 2px dashed #d1d5db;
    }

    .icon-status {
      font-size: 1.2rem;
    }

    .badge-modern {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .input-group-modern {
      display: flex;
      gap: 10px;
      align-items: end;
    }

    .valor-dourado {
      background: #ffffff;
      color: #d4af37;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
    }

    .valor-total-dourado {
      background: linear-gradient(135deg, #d4af37, #ffd700);
      color: #000000;
      font-weight: bold;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-top: 15px;
      box-shadow: 0 4px 6px rgba(212, 175, 55, 0.3);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content-custom {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow-lg);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .modal-title-custom {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--dark-color);
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-limpar-filtros {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }

    .btn-limpar-filtros:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
    }

    .multiplas-saidas-container {
      background: var(--light-bg);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid var(--success-color);
      display: none;
    }

    .saida-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .saida-info {
      flex: 1;
    }

    .saida-actions {
      display: flex;
      gap: 8px;
    }

    .btn-multiplas-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .main-container {
        margin: 10px;
        padding: 20px;
        border-radius: 16px;
      }
      
      .dashboard-cards {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }
      
      .dashboard-value {
        font-size: 1.4rem;
      }

      .btn-multiplas-container {
        flex-direction: column;
      }

      .chat-examples {
        justify-content: center;
      }

      .chat-bubble {
        max-width: 90%;
      }

      .header-actions {
        position: static;
        justify-content: center;
        margin-top: 20px;
      }

      .header-title {
        margin-bottom: 10px;
      }

      .modal-analise-content {
        width: 95%;
        margin: 20px;
        max-height: 85vh;
      }

      .modal-analise-header {
        padding: 20px;
      }

      .modal-analise-body {
        padding: 20px;
      }

      .resumo-stats {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
      }

      .insight-acoes {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <h1 class="header-title" style="display: flex; align-items: center; justify-content: center; position: relative;">
      <span style="margin-right: 15px; font-size: 2.5rem;">üìä</span>
      <span>CONTROLE ICLUB SA√çDAS</span>
      <div class="header-actions">
        <button class="btn-analise-inteligente" onclick="abrirAnaliseInteligente()">
          <i class="fas fa-brain"></i> An√°lise Inteligente
        </button>
      </div>
    </h1>

    <!-- MODAL TREINAMENTO IA -->
    <div id="modalTreinamentoIA" class="modal-treinamento">
      <div class="modal-treinamento-content">
        <div class="modal-treinamento-header">
          <h3 class="modal-treinamento-title">
            <i class="fas fa-graduation-cap"></i>
            Treinar IA - Ensine Padr√µes
          </h3>
          <button class="modal-treinamento-close" onclick="fecharTreinamentoIA()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-treinamento-body">
          <div class="mb-4">
            <h6 style="color: #667eea; font-weight: 700;">üéì Como Treinar a IA</h6>
            <p style="color: #6b7280; line-height: 1.6;">
              Ensine a IA a reconhecer padr√µes espec√≠ficos do seu neg√≥cio. 
              Quanto mais exemplos voc√™ fornecer, mais precisa ela ficar√°!
            </p>
          </div>

          <div class="treinamento-item">
            <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 8px;">
              üìù Frase de Exemplo:
            </label>
            <input type="text" id="treinamentoFrase" class="treinamento-input" 
                   placeholder="Ex: Paguei R$ 500 de aluguel da loja centro hoje">
            
            <div class="row g-2 mt-3">
              <div class="col-md-4">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">
                  üí∞ Valor:
                </label>
                <input type="text" id="treinamentoValor" class="treinamento-input" placeholder="500">
              </div>
              <div class="col-md-4">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">
                  üè∑Ô∏è Categoria:
                </label>
                <select id="treinamentoCategoria" class="treinamento-input">
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div class="col-md-4">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">
                  üè™ Loja:
                </label>
                <select id="treinamentoLoja" class="treinamento-input">
                  <option value="">Selecione...</option>
                </select>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 25px;">
            <button class="btn-analise-inteligente" onclick="salvarTreinamentoIA()" style="margin-right: 10px;">
              <i class="fas fa-save"></i> Salvar Treinamento
            </button>
            <button class="btn btn-secondary btn-modern" onclick="fecharTreinamentoIA()">
              Cancelar
            </button>
          </div>

          <div id="listaTreinamentos" style="margin-top: 25px;">
            <!-- Lista de treinamentos ser√° inserida aqui -->
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL AN√ÅLISE INTELIGENTE -->
    <div id="modalAnaliseInteligente" class="modal-analise">
      <div class="modal-analise-content">
        <div class="modal-analise-header">
          <h2 class="modal-analise-title">
            <i class="fas fa-brain"></i>
            An√°lise Inteligente de Dados
          </h2>
          <button class="modal-analise-close" onclick="fecharAnaliseInteligente()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-analise-body">
          <!-- Loading -->
          <div id="analiseLoading" class="analise-loading">
            <div class="spinner"></div>
            <h4>üß† Analisando seus dados...</h4>
            <p>Nossa IA est√° processando padr√µes, tend√™ncias e insights</p>
            <div class="progresso-analise">
              <div id="progressoBarra" class="progresso-barra"></div>
            </div>
            <p id="etapaAnalise">Carregando dados...</p>
          </div>

          <!-- Resultado -->
          <div id="analiseResultado" class="analise-resultado">
            <!-- Conte√∫do ser√° inserido via JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT IA INTEGRADO -->
    <div class="chat-ia-container">
      <div class="chat-header">
        <div class="chat-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="chat-title">
          <h5>üí¨ Chat Inteligente - IA aprende com voc√™</h5>
          <small>Digite suas sa√≠das em linguagem natural - ex: "Paguei R$ 500 de aluguel hoje"</small>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; padding: 8px 12px;" onclick="limparChat()">
            Limpar
          </button>
          <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; padding: 8px 12px;" onclick="mostrarTreinamentoIA()">
            Treinar IA
          </button>
        </div>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message system">
          <div class="chat-bubble">
            <div>üëã Ol√°! Eu sou a IA do iClub. Digite suas sa√≠das em linguagem natural e eu vou process√°-las automaticamente!</div>
            <div class="chat-time">Agora</div>
          </div>
        </div>
      </div>
      
      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span>IA processando...</span>
      </div>
      
      <div class="chat-input-container">
        <input type="text" 
               class="chat-input" 
               id="chatInput" 
               placeholder="Ex: Paguei R$ 500 de aluguel hoje..."
               autocomplete="off"
               maxlength="200">
        <button class="chat-send-btn" id="chatSendBtn" onclick="enviarMensagemChat()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      
      <div class="chat-examples">
        <button class="chat-example-btn" onclick="usarExemplo('Paguei R$ 1.200 de aluguel hoje')">
          Pagar aluguel
        </button>
        <button class="chat-example-btn" onclick="usarExemplo('Gastei R$ 80 de gasolina ontem')">
          Gasolina
        </button>
        <button class="chat-example-btn" onclick="usarExemplo('Comprei R$ 150 de material de escrit√≥rio')">
          Material
        </button>
        <button class="chat-example-btn" onclick="usarExemplo('Devo R$ 300 de energia el√©trica')">
          Conta pendente
        </button>
      </div>
    </div>

    <!-- Formul√°rio de Cadastro -->
    <div class="card-modern">
      <h5 class="status-title">
        Nova Sa√≠da
      </h5>
      
      <div class="row g-3">
        <div class="col-md-6 col-lg-2">
          <label class="form-label fw-bold">Loja</label>
          <select id="loja" class="form-select"></select>
          <button class="btn btn-outline-secondary btn-sm-modern mt-2 w-100" onclick="mostrarEditorLoja()">
            <i class="fas fa-edit"></i> Editar Lojas
          </button>
        </div>
        <div class="col-md-6 col-lg-2">
          <label class="form-label fw-bold">Centro de custo</label>
          <select id="categoria" class="form-select"></select>
          <button class="btn btn-outline-secondary btn-sm-modern mt-2 w-100" onclick="mostrarEditorCategoria()">
            <i class="fas fa-edit"></i> Editar Centros de custo
          </button>
        </div>
        <div class="col-md-6 col-lg-2">
          <label class="form-label fw-bold">Descri√ß√£o</label>
          <input type="text" id="descricao" class="form-control" placeholder="Digite a descri√ß√£o"/>
        </div>
        <div class="col-md-6 col-lg-2">
          <label class="form-label fw-bold">Valor (R$)</label>
          <input type="text" id="valor" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)"/>
        </div>
        <div class="col-md-6 col-lg-1">
          <label class="form-label fw-bold">Data</label>
          <input type="date" id="data" class="form-control"/>
        </div>
        <div class="col-md-6 col-lg-1">
          <label class="form-label fw-bold">Recorrente?</label>
          <select id="recorrente" class="form-select" onchange="toggleTipoRecorrencia()">
            <option>N√£o</option>
            <option>Sim</option>
          </select>
        </div>
        <div class="col-md-6 col-lg-1" id="colunaTipoRecorrencia" style="display:none;">
          <label class="form-label fw-bold">Tipo</label>
          <select id="tipoRecorrencia" class="form-select">
            <option disabled selected>Selecione</option>
            <option>Di√°ria</option>
            <option>Semanal</option>
            <option>Mensal</option>
            <option>Anual</option>
          </select>
        </div>
        <div class="col-md-6 col-lg-1">
          <label class="form-label fw-bold">Pago?</label>
          <select id="pago" class="form-select">
            <option>Sim</option>
            <option>N√£o</option>
          </select>
        </div>
        <div class="col-12">
          <div class="btn-multiplas-container">
            <button class="btn btn-success-modern btn-modern flex-fill" onclick="adicionarSaida()">
              <i class="fas fa-plus"></i> Adicionar Sa√≠da
            </button>
            <button class="btn btn-success-modern btn-modern flex-fill" onclick="iniciarMultiplasSaidas()">
              <i class="fas fa-clone"></i> Adicionar M√∫ltiplas Sa√≠das
            </button>
          </div>
          <div id="mensagemSucesso" class="alert alert-success mt-3" style="display:none;">
            ‚úÖ Sa√≠da adicionada!
          </div>
        </div>
      </div>

      <!-- Editor Loja -->
      <div id="editor-loja" class="editor-categoria" style="display:none">
        <div class="input-group-modern">
          <input type="text" id="novaLoja" placeholder="Nova loja" class="form-control"/>
          <button class="btn btn-success-modern btn-modern" onclick="adicionarLoja()">
            Adicionar
          </button>
          <button class="btn btn-warning btn-modern" onclick="mostrarEditorLojaExistente()">
            <i class="fas fa-edit"></i> Editar Lista
          </button>
        </div>
      </div>

      <!-- Editor Categoria -->
      <div id="editor-categoria" class="editor-categoria" style="display:none">
        <div class="input-group-modern">
          <input type="text" id="novaCategoria" placeholder="Novo centro de custo" class="form-control"/>
          <button class="btn btn-success-modern btn-modern" onclick="adicionarCategoria()">
            Adicionar
          </button>
          <button class="btn btn-warning btn-modern" onclick="mostrarEditorCategoriaExistente()">
            <i class="fas fa-edit"></i> Editar Lista
          </button>
        </div>
      </div>

      <!-- Container para M√∫ltiplas Sa√≠das -->
      <div id="multiplasSaidasContainer" class="multiplas-saidas-container">
        <h6 class="mb-3" style="color: var(--success-color); font-weight: 700;">
          <i class="fas fa-list"></i> Lista de Sa√≠das para Adicionar
        </h6>
        <div id="listaSaidas"></div>
        <div class="mt-3">
          <button class="btn btn-success-modern btn-modern me-2" onclick="adicionarNovaLinha()">
            <i class="fas fa-plus"></i> Adicionar Nova Linha
          </button>
          <button class="btn btn-success-modern btn-modern me-2" onclick="adicionarTodasSaidas()">
            <i class="fas fa-save"></i> Adicionar Todas Sa√≠das
          </button>
          <button class="btn btn-secondary btn-modern" onclick="cancelarMultiplasSaidas()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Filtro Global por Loja -->
    <div class="card-modern">
      <h5 class="status-title">
        Filtros Gerais
      </h5>
      <div class="row g-2">
        <div class="col-md-12">
          <label class="form-label fw-bold">Visualizar loja:</label>
          <select id="filtroLojaGlobal" class="form-select" onchange="aplicarFiltroLoja()">
            <option value="">üìä Todas as lojas (Consolidado)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Se√ß√µes de Status -->
    <div class="status-section status-atrasadas">
      <h5 class="status-title">
        Sa√≠das Atrasadas
      </h5>
      <div id="atrasadas"></div>
    </div>

    <div class="status-section status-vencendo">
      <h5 class="status-title">
        Sa√≠das Vencendo Hoje
      </h5>
      <div id="vencendoHoje"></div>
    </div>

    <div class="status-section status-proximas">
      <h5 class="status-title">
        Pr√≥ximas Sa√≠das a Vencer
      </h5>
      <div id="proximas"></div>
    </div>

    <div class="status-section status-recorrentes">
      <h5 class="status-title">
        Sa√≠das Recorrentes
      </h5>
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <label class="form-label fw-bold">Filtrar por loja:</label>
          <select id="filtroLojaRecorrentes" class="form-select" onchange="filtrarRecorrentesPorFiltros()">
            <option value="">Todas as lojas</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Filtrar por ano:</label>
          <select id="filtroAnoRecorrentes" class="form-select" onchange="preencherMesesDoAno()">
            <option value="">Todos os anos</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Filtrar por m√™s:</label>
          <select id="filtroMesRecorrentes" class="form-select" onchange="filtrarRecorrentesPorFiltros()">
            <option value="">Todos os meses</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Filtrar por centro de custo:</label>
          <div class="d-flex gap-2">
            <select id="filtroCategoriaRecorrentes" class="form-select" onchange="filtrarRecorrentesPorFiltros()">
              <option value="">Todos os centros de custo</option>
            </select>
            <button class="btn btn-limpar-filtros" onclick="limparFiltrosRecorrentes()" title="Limpar Filtros">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
      <div id="previsaoRecorrentes"></div>
      <div class="valor-total-dourado">
        <strong>Valor total sa√≠das: <span id="totalSaidasRecorrentes">R$ 0,00</span></strong>
      </div>
    </div>

    <!-- Sa√≠das do M√™s -->
    <div class="card-modern">
      <h4 class="status-title">
        Sa√≠das do M√™s
      </h4>
      <div class="table-responsive">
        <table class="table table-modern">
          <thead>
            <tr>
              <th>Loja</th>
              <th>Centro de custo</th>
              <th>Descri√ß√£o</th>
              <th>Valor</th>
              <th>Data</th>
              <th>Recorrente</th>
              <th>Tipo</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaSaidas"></tbody>
        </table>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="card-modern">
      <h4 class="status-title">
        Dashboard total sa√≠das do m√™s
      </h4>
      <div class="dashboard-cards">
        <div class="dashboard-card">
          <div class="dashboard-value" id="totalMes">R$ 0,00</div>
          <div class="dashboard-label">Total do M√™s</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-value" id="totalRecorrente">R$ 0,00</div>
          <div class="dashboard-label">Total Recorrente</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-value" id="maiorGasto">R$ 0,00</div>
          <div class="dashboard-label">Maior Gasto</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-value" id="categoriaTopo">-</div>
          <div class="dashboard-label">Centro de custo Topo</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-value" id="totalSaidas">0</div>
          <div class="dashboard-label">Total de Sa√≠das</div>
        </div>
      </div>
    </div>

    <!-- Comparativo entre Lojas -->
    <div class="card-modern" id="comparativoLojas">
      <h4 class="status-title">
        üìä Comparativo entre Lojas
      </h4>
      <div id="tabelaComparativo"></div>
      
      <!-- Gr√°fico Comparativo de Lojas -->
      <div class="chart-container mt-4">
        <h4 class="chart-title">
          Gr√°fico Comparativo por Loja
        </h4>
        <div class="d-flex justify-content-center align-items-center">
          <div style="width: 600px; height: 400px;">
            <canvas id="graficoLojas"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Gr√°fico Centros de Custo por Loja -->
      <div class="chart-container mt-4">
        <h4 class="chart-title">
          Gr√°fico de Centros de Custo por Loja
        </h4>
        <div class="d-flex justify-content-center align-items-center">
          <div style="width: 700px; height: 400px;">
            <canvas id="graficoCentrosCusto"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="chart-container">
      <h4 class="chart-title">
        Gr√°fico por Centro de custo
      </h4>
      <div class="d-flex justify-content-center align-items-center">
        <div style="width: 400px; height: 400px;">
          <canvas id="graficoCategoria"></canvas>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <h4 class="chart-title">
        Gr√°fico por Tipo de Gasto
      </h4>
      <div class="d-flex justify-content-center align-items-center">
        <div style="width: 400px; height: 400px;">
          <canvas id="graficoTipo"></canvas>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <h4 class="chart-title">
        Gr√°fico de Sa√≠das por M√™s
      </h4>
      <div class="d-flex justify-content-center align-items-center">
        <div style="width: 600px; height: 400px;">
          <canvas id="graficoMes"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal personalizado -->
  <div id="modalCustom" class="modal-overlay" style="display: none;">
    <div class="modal-content-custom">
      <div class="modal-title-custom" id="modalTitulo">T√≠tulo do Modal</div>
      <div id="modalTexto" style="margin-bottom: 20px;"></div>
      <div class="modal-buttons" id="modalBotoes">
        <!-- Bot√µes ser√£o inseridos aqui -->
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // SISTEMA PRINCIPAL ICLUB - INTEGRADO
    // ============================================================================
    
    // Vari√°veis globais
    let categorias = [
      "Aluguel", "Energia", "Internet", "Combust√≠vel", "Material", 
      "Transporte", "Alimenta√ß√£o", "Marketing", "Sa√∫de"
    ];
    let lojas = ["Loja Centro", "Loja Shopping", "Loja Bairro"];
    let saidas = [];
    let saidasPendentes = [];
    let lojaFiltroAtual = "";
    let multiplasSaidasLista = [];
    let contadorMultiplas = 0;
    
    // Treinamento IA
    let treinamentosIA = JSON.parse(localStorage.getItem('treinamentosIA') || '[]');
    
    // Chat IA
    let aguardandoSelecaoLoja = false;
    let saidaPendenteLoja = null;
    
    // ============================================================================
    // SISTEMA DE TREINAMENTO IA
    // ============================================================================
    
    function mostrarTreinamentoIA() {
      const modal = document.getElementById('modalTreinamentoIA');
      modal.style.display = 'block';
      
      // Preencher selects
      preencherSelectTreinamento();
      listarTreinamentos();
    }
    
    function fecharTreinamentoIA() {
      document.getElementById('modalTreinamentoIA').style.display = 'none';
      limparFormularioTreinamento();
    }
    
    function preencherSelectTreinamento() {
      // Categorias
      const selectCat = document.getElementById('treinamentoCategoria');
      selectCat.innerHTML = '<option value="">Selecione...</option>';
      categorias.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        selectCat.appendChild(option);
      });
      
      // Lojas
      const selectLoja = document.getElementById('treinamentoLoja');
      selectLoja.innerHTML = '<option value="">Selecione...</option>';
      lojas.forEach(loja => {
        const option = document.createElement('option');
        option.value = loja;
        option.textContent = loja;
        selectLoja.appendChild(option);
      });
    }
    
    function salvarTreinamentoIA() {
      const frase = document.getElementById('treinamentoFrase').value.trim();
      const valor = document.getElementById('treinamentoValor').value.trim();
      const categoria = document.getElementById('treinamentoCategoria').value;
      const loja = document.getElementById('treinamentoLoja').value;
      
      if (!frase || !valor || !categoria || !loja) {
        alert('Preencha todos os campos para treinar a IA!');
        return;
      }
      
      const treinamento = {
        id: Date.now(),
        frase: frase.toLowerCase(),
        valor: parseFloat(valor.replace(/[^0-9,]/g, '').replace(',', '.')),
        categoria,
        loja,
        criadoEm: new Date().toISOString()
      };
      
      treinamentosIA.push(treinamento);
      localStorage.setItem('treinamentosIA', JSON.stringify(treinamentosIA));
      
      mostrarMensagemSucesso('‚úÖ IA treinada com sucesso!');
      limparFormularioTreinamento();
      listarTreinamentos();
    }
    
    function limparFormularioTreinamento() {
      document.getElementById('treinamentoFrase').value = '';
      document.getElementById('treinamentoValor').value = '';
      document.getElementById('treinamentoCategoria').value = '';
      document.getElementById('treinamentoLoja').value = '';
    }
    
    function listarTreinamentos() {
      const lista = document.getElementById('listaTreinamentos');
      
      if (treinamentosIA.length === 0) {
        lista.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #6b7280;">
            <i class="fas fa-lightbulb" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <p>Nenhum treinamento ainda. Adicione exemplos para melhorar a IA!</p>
          </div>
        `;
        return;
      }
      
      lista.innerHTML = `
        <h6 style="color: #667eea; font-weight: 700; margin-bottom: 15px;">
          üìö Treinamentos Salvos (${treinamentosIA.length})
        </h6>
        ${treinamentosIA.slice(-5).reverse().map(t => `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">
              "${t.frase}"
            </div>
            <div style="font-size: 0.85rem; color: #6b7280;">
              üí∞ R$ ${t.valor.toFixed(2)} ‚Ä¢ üè∑Ô∏è ${t.categoria} ‚Ä¢ üè™ ${t.loja}
            </div>
          </div>
        `).join('')}
      `;
    }
    
    // ============================================================================
    // CHAT IA INTELIGENTE
    // ============================================================================
    
    function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const mensagem = input.value.trim();
      
      if (!mensagem) return;
      
      input.value = '';
      document.getElementById('chatSendBtn').disabled = true;
      
      if (aguardandoSelecaoLoja) {
        processarSelecaoLoja(mensagem);
        return;
      }
      
      adicionarMensagemChat('user', mensagem);
      mostrarTyping();
      
      setTimeout(() => {
        processarMensagemIA(mensagem);
      }, 1500);
    }
    
    function adicionarMensagemChat(tipo, texto) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      
      const agora = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${tipo}`;
      
      messageDiv.innerHTML = `
        <div class="chat-bubble">
          <div>${texto}</div>
          <div class="chat-time">${agora}</div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function mostrarTyping() {
      const typing = document.getElementById('typingIndicator');
      if (typing) {
        typing.style.display = 'flex';
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
      }
    }
    
    function esconderTyping() {
      const typing = document.getElementById('typingIndicator');
      if (typing) {
        typing.style.display = 'none';
      }
      document.getElementById('chatSendBtn').disabled = false;
    }
    
    async function processarMensagemIA(mensagem) {
      try {
        console.log('üß† Processando:', mensagem);
        
        // Verificar se √© m√∫ltiplas sa√≠das
        const saidasMultiplas = detectarSaidasMultiplas(mensagem);
        
        if (saidasMultiplas.length > 1) {
          await processarSaidasMultiplas(saidasMultiplas, mensagem);
          return;
        }
        
        // Interpretar mensagem √∫nica
        const resultado = interpretarMensagemIA(mensagem);
        esconderTyping();
        
        if (!resultado.sucesso) {
          const erro = `‚ùå ${resultado.erro}

üí° Exemplos v√°lidos:
‚Ä¢ "Paguei 500 de aluguel hoje"
‚Ä¢ "Gastei 80 de gasolina ontem"  
‚Ä¢ "Devo 200 de internet"`;
          
          adicionarMensagemChat('system', erro);
          return;
        }
        
        // Verificar informa√ß√µes obrigat√≥rias
        const validacao = validarInformacoesObrigatorias(resultado, mensagem);
        
        if (!validacao.valido) {
          await solicitarInformacoesFaltantes(validacao, resultado, mensagem);
          return;
        }
        
        // Processar sa√≠da completa
        const lojaMencionada = detectarLojaNaMensagem(mensagem);
        
        if (lojaMencionada) {
          const saidaData = criarDadosSaida(resultado, lojaMencionada);
          await finalizarAdicaoSaida(saidaData);
        } else {
          await solicitarSelecaoLoja(resultado);
        }
        
      } catch (error) {
        console.error('‚ùå Erro processamento:', error);
        esconderTyping();
        adicionarMensagemChat('system', '‚ùå Erro ao processar. Tente novamente.');
      }
    }
    
    function interpretarMensagemIA(mensagem) {
      try {
        const msgOriginal = mensagem.trim();
        const msgLower = mensagem.toLowerCase().trim();
        
        console.log('üß† IA analisando:', msgLower.substring(0, 50));

        // Verificar treinamentos espec√≠ficos primeiro
        const treinamentoEncontrado = buscarTreinamento(msgLower);
        if (treinamentoEncontrado) {
          console.log('üéì Usando treinamento:', treinamentoEncontrado);
          return {
            sucesso: true,
            categoria: treinamentoEncontrado.categoria,
            valor: treinamentoEncontrado.valor,
            data: new Date().toISOString().split('T')[0],
            descricao: treinamentoEncontrado.categoria, // S√≥ o nome da categoria
            pago: detectarStatusPagamento(msgLower),
            recorrente: "N√£o",
            tipoRecorrencia: null,
            fonte: 'treinamento'
          };
        }

        // Padr√µes de reconhecimento
        const padroes = {
          valor: /(?:r\$?\s*)?(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?|\d+)\s*(?:reais?|real|pila|conto|pau|dinheiro)?/i,
          dataHoje: /\b(?:hoje|hj|agora)\b/i,
          dataOntem: /\b(?:ontem|onte)\b/i,
          dataAmanha: /\b(?:amanh√£|amanha|tomorrow)\b/i,
          acoesPago: /\b(?:pague[i]?|gaste[i]?|compre[i]?|pago|pagou|gastou|comprou|sa√≠da|despesa|d√©bito|desembolsei?)\b/i,
          acoesNaoPago: /\b(?:devo|deve|preciso\s+pagar|vou\s+pagar|pendente|conta\s+para\s+pagar|a\s+pagar|fatura|boleto)\b/i,
          recorrente: /\b(?:mensal|todo\s+m√™s|mensalmente|recorrente|fixo|sempre|mensalidade)\b/i
        };

        // Categorias
        const categoriasIA = {
          'Aluguel': { regex: /\b(?:aluguel|aluguer|rent|loca√ß√£o|arrendamento)\b/i, confianca: 0.95 },
          'Energia': { regex: /\b(?:energia|luz|el√©trica|eletricidade|conta\s+de\s+luz|enel|cpfl|cemig)\b/i, confianca: 0.9 },
          'Internet': { regex: /\b(?:internet|wifi|banda\s+larga|provedor|vivo\s+fibra|claro\s+net|tim\s+live)\b/i, confianca: 0.9 },
          'Combust√≠vel': { regex: /\b(?:combust√≠vel|gasolina|etanol|diesel|posto|abasteci|√°lcool|combustivel|gas)\b/i, confianca: 0.9 },
          'Material': { regex: /\b(?:material|escrit√≥rio|papelaria|equipamento|ferramenta|suprimento)\b/i, confianca: 0.8 },
          'Transporte': { regex: /\b(?:transporte|uber|taxi|√¥nibus|onibus|metr√¥|metro|passagem|viagem|corrida)\b/i, confianca: 0.85 },
          'Alimenta√ß√£o': { regex: /\b(?:alimenta√ß√£o|comida|mercado|supermercado|restaurante|lanche|caf√©|delivery)\b/i, confianca: 0.8 },
          'Marketing': { regex: /\b(?:marketing|publicidade|an√∫ncio|anuncio|propaganda|google\s+ads|facebook\s+ads)\b/i, confianca: 0.8 },
          'Sa√∫de': { regex: /\b(?:sa√∫de|saude|m√©dico|medico|hospital|farm√°cia|farmacia|rem√©dio|remedio)\b/i, confianca: 0.85 }
        };

        // EXTRAIR VALOR
        const matchValor = msgLower.match(padroes.valor);
        if (!matchValor) {
          return { sucesso: false, erro: "N√£o consegui identificar o valor na mensagem" };
        }
        
        let valorTexto = matchValor[1];
        console.log('üí∞ Valor detectado:', valorTexto);
        
        // Processar n√∫meros simples (ex: 2000)
        if (/^\d+$/.test(valorTexto)) {
          const numeroSimples = parseInt(valorTexto);
          if (numeroSimples >= 10) {
            valorTexto = numeroSimples.toString();
          }
        } else {
          // Processar formatos com pontos e v√≠rgulas
          if (valorTexto.includes('.') && !valorTexto.includes(',')) {
            const partes = valorTexto.split('.');
            if (partes.length === 2 && partes[1].length === 3) {
              valorTexto = valorTexto.replace('.', '');
            } else if (partes.length === 2 && partes[1].length <= 2) {
              valorTexto = valorTexto.replace('.', ',');
            }
          }
          
          if (valorTexto.includes(',')) {
            valorTexto = valorTexto.replace(/\./g, '').replace(',', '.');
          }
        }
        
        const valor = parseFloat(valorTexto);
        console.log('üí∞ Valor processado:', valor);
        
        if (isNaN(valor) || valor <= 0) {
          return { sucesso: false, erro: `Valor inv√°lido: ${matchValor[1]}` };
        }

        // EXTRAIR DATA
        let data = new Date().toISOString().split('T')[0];
        
        if (padroes.dataOntem.test(msgLower)) {
          const ontem = new Date();
          ontem.setDate(ontem.getDate() - 1);
          data = ontem.toISOString().split('T')[0];
        } else if (padroes.dataAmanha.test(msgLower)) {
          const amanha = new Date();
          amanha.setDate(amanha.getDate() + 1);
          data = amanha.toISOString().split('T')[0];
        }

        // IDENTIFICAR CATEGORIA
        let melhorCategoria = "Outros";
        let maiorConfianca = 0;
        
        for (const [categoria, config] of Object.entries(categoriasIA)) {
          if (config.regex.test(msgLower)) {
            if (config.confianca > maiorConfianca) {
              melhorCategoria = categoria;
              maiorConfianca = config.confianca;
            }
          }
        }

        // STATUS DE PAGAMENTO
        let pago = "Sim";
        
        if (padroes.acoesNaoPago.test(msgLower)) {
          pago = "N√£o";
        } else if (padroes.acoesPago.test(msgLower)) {
          pago = "Sim";
        }

        // RECORR√äNCIA
        let recorrente = "N√£o";
        let tipoRecorrencia = null;
        
        if (padroes.recorrente.test(msgLower)) {
          recorrente = "Sim";
          tipoRecorrencia = "Mensal";
        }

        // DESCRI√á√ÉO: apenas o nome da categoria
        let descricao = melhorCategoria;

        const resultado = {
          sucesso: true,
          categoria: melhorCategoria,
          valor: valor,
          data: data,
          descricao: descricao, // S√≥ o nome da categoria
          pago: pago,
          recorrente: recorrente,
          tipoRecorrencia: tipoRecorrencia
        };

        console.log('üéØ Resultado IA:', resultado);
        return resultado;
        
      } catch (error) {
        console.error('‚ùå Erro IA:', error);
        return { sucesso: false, erro: `Erro no processamento: ${error.message}` };
      }
    }
    
    function buscarTreinamento(mensagem) {
      // Buscar treinamento mais similar
      let melhorTreinamento = null;
      let melhorScore = 0;
      
      for (const treinamento of treinamentosIA) {
        const score = calcularSimilaridade(mensagem, treinamento.frase);
        if (score > melhorScore && score > 0.7) { // 70% de similaridade
          melhorScore = score;
          melhorTreinamento = treinamento;
        }
      }
      
      return melhorTreinamento;
    }
    
    function calcularSimilaridade(str1, str2) {
      const palavras1 = str1.toLowerCase().split(' ').filter(p => p.length > 2);
      const palavras2 = str2.toLowerCase().split(' ').filter(p => p.length > 2);
      
      let matches = 0;
      for (const palavra1 of palavras1) {
        for (const palavra2 of palavras2) {
          if (palavra1.includes(palavra2) || palavra2.includes(palavra1)) {
            matches++;
            break;
          }
        }
      }
      
      return matches / Math.max(palavras1.length, palavras2.length);
    }
    
    function detectarStatusPagamento(mensagem) {
      const padroesPago = /\b(?:pague[i]?|gaste[i]?|compre[i]?|pago|pagou|gastou|comprou)\b/i;
      const padroesNaoPago = /\b(?:devo|deve|preciso\s+pagar|vou\s+pagar|pendente)\b/i;
      
      if (padroesNaoPago.test(mensagem)) return "N√£o";
      if (padroesPago.test(mensagem)) return "Sim";
      return "Sim"; // Default
    }
    
    function detectarSaidasMultiplas(mensagem) {
      const msgLower = mensagem.toLowerCase();
      
      // Padr√£o para m√∫ltiplas lojas: "de castanhal, belem e mix"
      const padraoMultiploLojas = /de\s+([^,]+(?:,\s*[^,]+)*(?:\s+e\s+[^,\s]+)?)/i;
      const matchLojas = msgLower.match(padraoMultiploLojas);
      
      if (matchLojas) {
        const lojasTexto = matchLojas[1];
        const lojasDetectadas = lojasTexto.split(/,|\s+e\s+/).map(l => l.trim()).filter(l => l);
        
        if (lojasDetectadas.length > 1) {
          // Mapear para lojas conhecidas
          const lojasValidas = [];
          
          lojasDetectadas.forEach(lojaTexto => {
            const lojaEncontrada = lojas.find(l => 
              l.toLowerCase().includes(lojaTexto) || 
              lojaTexto.includes(l.toLowerCase().split(' ')[0])
            );
            
            if (lojaEncontrada) {
              lojasValidas.push(lojaEncontrada);
            } else {
              // Criar loja baseada no texto
              lojasValidas.push(`Loja ${lojaTexto.charAt(0).toUpperCase() + lojaTexto.slice(1)}`);
            }
          });
          
          return lojasValidas;
        }
      }
      
      return [];
    }
    
    async function processarSaidasMultiplas(lojasDetectadas, mensagemOriginal) {
      try {
        const resultado = interpretarMensagemIA(mensagemOriginal);
        
        if (!resultado.sucesso) {
          adicionarMensagemChat('system', `‚ùå ${resultado.erro}`);
          return;
        }
        
        let sucessos = 0;
        
        for (const loja of lojasDetectadas) {
          const saidaData = criarDadosSaida(resultado, loja);
          
          try {
            // Adicionar √†s sa√≠das locais
            if (saidaData.pago === 'Sim') {
              saidas.unshift(saidaData);
            } else {
              saidasPendentes.unshift(saidaData);
            }
            sucessos++;
          } catch (error) {
            console.error('‚ùå Erro sa√≠da m√∫ltipla:', error);
          }
        }
        
        salvarDadosLocal();
        atualizarInterfaceCompleta();
        
        const resposta = `‚úÖ ${sucessos} sa√≠das adicionadas com sucesso!

üí∞ Valor: ${formatarMoedaBR(resultado.valor)} cada
üìä Categoria: ${resultado.categoria}
üè™ Lojas: ${lojasDetectadas.join(', ')}
üìÖ Data: ${new Date(resultado.data + 'T00:00:00').toLocaleDateString('pt-BR')}

ü§ñ Processamento m√∫ltiplo pela IA`;
        
        adicionarMensagemChat('system', resposta);
        mostrarMensagemSucesso(`‚úÖ ${sucessos} sa√≠das adicionadas via IA!`);
        
      } catch (error) {
        console.error('‚ùå Erro processamento m√∫ltiplo:', error);
        adicionarMensagemChat('system', '‚ùå Erro ao processar sa√≠das m√∫ltiplas.');
      }
    }
    
    function validarInformacoesObrigatorias(resultado, mensagem) {
      const problemas = [];
      
      // Verificar valor
      if (!resultado.valor || resultado.valor <= 0) {
        problemas.push('valor');
      }
      
      // Verificar categoria
      if (!resultado.categoria || resultado.categoria === 'Outros') {
        problemas.push('categoria');
      }
      
      return {
        valido: problemas.length === 0,
        problemas: problemas,
        resultado: resultado
      };
    }
    
    async function solicitarInformacoesFaltantes(validacao, resultado, mensagem) {
      const problemas = validacao.problemas;
      
      if (problemas.includes('valor')) {
        adicionarMensagemChat('system', 'üí∞ N√£o consegui identificar o valor. Qual o valor da sa√≠da?\n\nüìù Exemplo: "R$ 500" ou "500"');
        return;
      }
      
      if (problemas.includes('categoria')) {
        adicionarMensagemChat('system', `üè∑Ô∏è N√£o consegui identificar a categoria. Para que √© esta sa√≠da?\n\nüìù Categorias dispon√≠veis:\n${categorias.map(c => `‚Ä¢ ${c}`).join('\n')}`);
        return;
      }
    }
    
    async function solicitarSelecaoLoja(resultado) {
      const saidaData = criarDadosSaida(resultado, null);
      
      saidaPendenteLoja = saidaData;
      aguardandoSelecaoLoja = true;
      
      const pergunta = `‚úÖ Entendi! Sa√≠da de ${formatarMoedaBR(resultado.valor)} para ${resultado.categoria}.

üìç Para qual loja √© esta sa√≠da?`;
      
      adicionarMensagemChat('system', pergunta);
      
      const opcoesTexto = lojas.map((loja, index) => `${index + 1}. ${loja}`).join('\n');
      adicionarMensagemChat('system', `Escolha uma op√ß√£o:\n\n${opcoesTexto}`);
    }
    
    function processarSelecaoLoja(resposta) {
      const numeroEscolhido = parseInt(resposta.trim());
      
      if (numeroEscolhido >= 1 && numeroEscolhido <= lojas.length) {
        const lojaEscolhida = lojas[numeroEscolhido - 1];
        saidaPendenteLoja.loja = lojaEscolhida;
        
        adicionarMensagemChat('user', resposta);
        finalizarAdicaoSaida(saidaPendenteLoja);
        
        aguardandoSelecaoLoja = false;
        saidaPendenteLoja = null;
        
      } else {
        adicionarMensagemChat('user', resposta);
        adicionarMensagemChat('system', `‚ùå Op√ß√£o inv√°lida. Digite um n√∫mero de 1 a ${lojas.length}:`);
        
        const opcoesTexto = lojas.map((loja, index) => `${index + 1}. ${loja}`).join('\n');
        adicionarMensagemChat('system', opcoesTexto);
      }
      
      document.getElementById('chatSendBtn').disabled = false;
    }
    
    function criarDadosSaida(resultado, loja) {
      return {
        id: Date.now() + Math.random() * 1000,
        loja: loja,
        categoria: resultado.categoria,
        descricao: resultado.descricao, // S√≥ o nome da categoria
        valor: resultado.valor,
        data: resultado.data,
        recorrente: resultado.recorrente || "N√£o",
        tipoRecorrencia: resultado.tipoRecorrencia || null,
        pago: resultado.pago,
        origem: 'chat',
        timestamp: new Date(),
        dataProcessamento: new Date().toISOString()
      };
    }
    
    function detectarLojaNaMensagem(mensagem) {
      const msgLower = mensagem.toLowerCase();
      
      // Procurar men√ß√£o direta das lojas
      for (const loja of lojas) {
        if (msgLower.includes(loja.toLowerCase())) {
          return loja;
        }
      }
      
      // Procurar palavras-chave
      if (msgLower.includes('centro')) {
        const lojasCentro = lojas.filter(l => l.toLowerCase().includes('centro'));
        if (lojasCentro.length > 0) return lojasCentro[0];
      }
      
      if (msgLower.includes('shopping')) {
        const lojasShoppingas = lojas.filter(l => l.toLowerCase().includes('shopping'));
        if (lojasShoppingas.length > 0) return lojasShoppingas[0];
      }
      
      if (msgLower.includes('bairro')) {
        const lojasBairro = lojas.filter(l => l.toLowerCase().includes('bairro'));
        if (lojasBairro.length > 0) return lojasBairro[0];
      }
      
      return null;
    }
    
    async function finalizarAdicaoSaida(saidaData) {
      try {
        if (saidaData.pago === 'Sim') {
          saidas.unshift(saidaData);
        } else {
          saidasPendentes.unshift(saidaData);
        }
        salvarDadosLocal();
        atualizarInterfaceCompleta();
        
        const resposta = gerarRespostaChat(saidaData);
        adicionarMensagemChat('system', resposta);
        mostrarMensagemSucesso('‚úÖ Sa√≠da adicionada via Chat IA!');
        
      } catch (error) {
        console.error('‚ùå Erro finalizar:', error);
        adicionarMensagemChat('system', '‚ùå Erro ao salvar. Tente novamente.');
      }
    }
    
    function gerarRespostaChat(saida) {
      const dataFormatada = new Date(saida.data + 'T00:00:00').toLocaleDateString('pt-BR');
      const valorFormatado = saida.valor.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
      
      const emojiCategoria = {
        'Aluguel': 'üè†', 'Energia': '‚ö°', 'Internet': 'üåê', 'Combust√≠vel': '‚õΩ',
        'Material': 'üì¶', 'Transporte': 'üöó', 'Alimenta√ß√£o': 'üçΩÔ∏è', 'Marketing': 'üì¢', 'Sa√∫de': 'üè•'
      };
      
      const emoji = emojiCategoria[saida.categoria] || 'üìä';
      
      return `‚úÖ Sa√≠da registrada com sucesso!

üí∞ Valor: ${valorFormatado}
${emoji} Categoria: ${saida.categoria}
üè™ Loja: ${saida.loja}
üìÖ Data: ${dataFormatada}
üí≥ Status: ${saida.pago === "Sim" ? "Pago ‚úÖ" : "Pendente ‚è≥"}

ü§ñ Processado pela IA`;
    }
    
    function usarExemplo(exemplo) {
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.value = exemplo;
        enviarMensagemChat();
      }
    }
    
    function limparChat() {
      const chatMessages = document.getElementById('chatMessages');
      if (chatMessages) {
        chatMessages.innerHTML = `
          <div class="chat-message system">
            <div class="chat-bubble">
              <div>üëã Ol√°! Eu sou a IA do iClub. Digite suas sa√≠das agora e eu vou adicionar automaticamente para voc√™!</div>
              <div class="chat-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          </div>
        `;
      }
    }
    
    // ============================================================================
    // FUN√á√ïES PRINCIPAIS DO SISTEMA
    // ============================================================================
    
    function adicionarSaida() {
      const loja = document.getElementById("loja")?.value || "Manual";
      const categoria = document.getElementById("categoria")?.value || "Outros";
      const descricao = document.getElementById("descricao")?.value || categoria; // Usar categoria se descri√ß√£o vazia
      const valorInput = document.getElementById("valor")?.value || "0";
      const valor = extrairValorNumerico(valorInput);
      const data = document.getElementById("data")?.value || new Date().toISOString().split('T')[0];
      const recorrente = document.getElementById("recorrente")?.value || "N√£o";
      const tipoRecorrencia = document.getElementById("tipoRecorrencia")?.value || null;
      const pago = document.getElementById("pago")?.value || "Sim";

      if (valor <= 0) {
        alert("Por favor, insira um valor v√°lido!");
        return;
      }

      const saida = { 
        id: Date.now() + Math.random() * 1000, 
        loja, categoria, 
        descricao: descricao || categoria, // Garantir que tenha descri√ß√£o
        valor, data, recorrente,
        tipoRecorrencia: recorrente === "Sim" ? tipoRecorrencia : null,
        pago, origem: 'manual', timestamp: new Date()
      };

      try {
        if (pago === "Sim") {
          saidas.unshift(saida);
        } else {
          saidasPendentes.unshift(saida);
        }
        salvarDadosLocal();
        atualizarInterfaceCompleta();
        mostrarMensagemSucesso('‚úÖ Sa√≠da adicionada com sucesso!');
        limparFormulario();
        
      } catch (error) {
        console.error('‚ùå Erro adicionar sa√≠da:', error);
        alert('Erro ao salvar sa√≠da. Tente novamente.');
      }
    }
    
    function excluirSaida(firestoreId, saidaId) {
      if (!confirm('Tem certeza que deseja excluir esta sa√≠da?')) return;

      try {
        saidas = saidas.filter(s => s.id !== saidaId);
        saidasPendentes = saidasPendentes.filter(s => s.id !== saidaId);
        salvarDadosLocal();
        atualizarInterfaceCompleta();
        mostrarMensagemSucesso('‚úÖ Sa√≠da exclu√≠da!');
      } catch (error) {
        console.error('‚ùå Erro excluir:', error);
        alert('Erro ao excluir sa√≠da. Tente novamente.');
      }
    }
    
    function marcarComoPago(firestoreId, saidaId) {
      if (!confirm('Marcar esta sa√≠da como paga?')) return;

      try {
        const saida = [...saidas, ...saidasPendentes].find(s => s.id === saidaId);
        if (saida) {
          saida.pago = 'Sim';
          saidasPendentes = saidasPendentes.filter(s => s.id !== saidaId);
          saidas.unshift(saida);
          salvarDadosLocal();
          atualizarInterfaceCompleta();
          mostrarMensagemSucesso('‚úÖ Sa√≠da marcada como paga!');
        }
      } catch (error) {
        console.error('‚ùå Erro marcar como pago:', error);
        alert('Erro ao atualizar sa√≠da. Tente novamente.');
      }
    }
    
    function editarSaida(firestoreId, saidaId) {
      alert('Funcionalidade de edi√ß√£o em desenvolvimento');
    }
    
    // ============================================================================
    // GEST√ÉO DE CATEGORIAS E LOJAS
    // ============================================================================
    
    function mostrarEditorCategoria() {
      const editor = document.getElementById("editor-categoria");
      if (editor) {
        if (editor.style.display === "none") {
          editor.style.display = "block";
        } else {
          editor.style.display = "none";
        }
      }
    }

    function mostrarEditorLoja() {
      const editor = document.getElementById("editor-loja");
      if (editor) {
        if (editor.style.display === "none") {
          editor.style.display = "block";
        } else {
          editor.style.display = "none";
        }
      }
    }

    function adicionarCategoria() {
      const input = document.getElementById("novaCategoria");
      if (!input) return;
      
      const novaCategoria = input.value.trim();
      
      if (!novaCategoria) {
        alert("Digite o nome da categoria!");
        return;
      }
      
      if (categorias.includes(novaCategoria)) {
        alert("Esta categoria j√° existe!");
        return;
      }
      
      categorias.push(novaCategoria);
      input.value = "";
      
      salvarDadosLocal();
      atualizarInterfaceCompleta();
      mostrarMensagemSucesso(`‚úÖ Categoria "${novaCategoria}" adicionada!`);
    }

    function adicionarLoja() {
      const input = document.getElementById("novaLoja");
      if (!input) return;
      
      const novaLoja = input.value.trim();
      
      if (!novaLoja) {
        alert("Digite o nome da loja!");
        return;
      }
      
      if (lojas.includes(novaLoja)) {
        alert("Esta loja j√° existe!");
        return;
      }
      
      lojas.push(novaLoja);
      input.value = "";
      
      salvarDadosLocal();
      atualizarInterfaceCompleta();
      mostrarMensagemSucesso(`‚úÖ Loja "${novaLoja}" adicionada!`);
    }
    
    function mostrarEditorCategoriaExistente() {
      const lista = categorias.map((cat, index) => 
        `${index + 1}. ${cat} <button onclick="removerCategoria(${index})" class="btn btn-danger btn-sm">‚ùå</button>`
      ).join('<br>');
      
      const modal = document.getElementById('modalCustom');
      if (modal) {
        document.getElementById('modalTitulo').textContent = 'Editar Categorias';
        document.getElementById('modalTexto').innerHTML = lista || 'Nenhuma categoria cadastrada.';
        document.getElementById('modalBotoes').innerHTML = `
          <button class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
        `;
        modal.style.display = 'flex';
      }
    }

    function mostrarEditorLojaExistente() {
      const lista = lojas.map((loja, index) => 
        `${index + 1}. ${loja} <button onclick="removerLoja(${index})" class="btn btn-danger btn-sm">‚ùå</button>`
      ).join('<br>');
      
      const modal = document.getElementById('modalCustom');
      if (modal) {
        document.getElementById('modalTitulo').textContent = 'Editar Lojas';
        document.getElementById('modalTexto').innerHTML = lista || 'Nenhuma loja cadastrada.';
        document.getElementById('modalBotoes').innerHTML = `
          <button class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
        `;
        modal.style.display = 'flex';
      }
    }

    function removerCategoria(index) {
      const categoria = categorias[index];
      if (confirm(`Tem certeza que deseja remover a categoria "${categoria}"?`)) {
        categorias.splice(index, 1);
        salvarDadosLocal();
        atualizarInterfaceCompleta();
        mostrarEditorCategoriaExistente();
        mostrarMensagemSucesso(`‚úÖ Categoria "${categoria}" removida!`);
      }
    }

    function removerLoja(index) {
      const loja = lojas[index];
      if (confirm(`Tem certeza que deseja remover a loja "${loja}"?`)) {
        lojas.splice(index, 1);
        salvarDadosLocal();
        atualizarInterfaceCompleta();
        mostrarEditorLojaExistente();
        mostrarMensagemSucesso(`‚úÖ Loja "${loja}" removida!`);
      }
    }

    function fecharModal() {
      const modal = document.getElementById('modalCustom');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // ============================================================================
    // M√öLTIPLAS SA√çDAS
    // ============================================================================
    
    function iniciarMultiplasSaidas() {
      multiplasSaidasLista = [];
      contadorMultiplas = 0;
      
      const container = document.getElementById("multiplasSaidasContainer");
      if (container) {
        container.style.display = "block";
        adicionarNovaLinha();
      }
    }

    function adicionarNovaLinha() {
      contadorMultiplas++;
      const listaSaidas = document.getElementById("listaSaidas");
      if (!listaSaidas) return;
      
      const novaLinha = document.createElement("div");
      novaLinha.className = "saida-item";
      novaLinha.id = `saida-${contadorMultiplas}`;
      
      novaLinha.innerHTML = `
        <div class="saida-info">
          <div class="row g-2">
            <div class="col-md-2">
              <select class="form-select form-select-sm loja-select" id="loja-${contadorMultiplas}">
                ${lojas.map(loja => `<option value="${loja}">${loja}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select form-select-sm categoria-select" id="categoria-${contadorMultiplas}">
                ${categorias.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm descricao-input" id="descricao-${contadorMultiplas}" placeholder="Descri√ß√£o">
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control form-control-sm valor-input" id="valor-${contadorMultiplas}" placeholder="R$ 0,00" oninput="formatarMoedaMultiplas(this)">
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control form-control-sm data-input" id="data-${contadorMultiplas}" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="col-md-1">
              <select class="form-select form-select-sm pago-select" id="pago-${contadorMultiplas}">
                <option>Sim</option>
                <option>N√£o</option>
              </select>
            </div>
          </div>
        </div>
        <div class="saida-actions">
          <button class="btn btn-danger btn-sm" onclick="removerLinhaSaida(${contadorMultiplas})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      listaSaidas.appendChild(novaLinha);
    }

    function formatarMoedaMultiplas(input) {
      let valor = input.value.replace(/\D/g, '');
      
      if (valor === '') {
        input.value = '';
        return;
      }
      
      valor = parseInt(valor);
      const valorFormatado = (valor / 100).toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
      
      input.value = valorFormatado;
    }

    function removerLinhaSaida(id) {
      const elemento = document.getElementById(`saida-${id}`);
      if (elemento) {
        elemento.remove();
      }
    }

    function adicionarTodasSaidas() {
      const listaSaidas = document.getElementById("listaSaidas");
      if (!listaSaidas) return;
      
      const linhas = listaSaidas.querySelectorAll('.saida-item');
      
      let sucessos = 0;
      let erros = 0;
      
      for (const linha of linhas) {
        const id = linha.id.split('-')[1];
        
        const loja = document.getElementById(`loja-${id}`)?.value;
        const categoria = document.getElementById(`categoria-${id}`)?.value;
        const descricao = document.getElementById(`descricao-${id}`)?.value || categoria; // Usar categoria se vazio
        const valorInput = document.getElementById(`valor-${id}`)?.value;
        const valor = extrairValorNumerico(valorInput);
        const data = document.getElementById(`data-${id}`)?.value;
        const pago = document.getElementById(`pago-${id}`)?.value;
        
        if (valor <= 0) {
          erros++;
          continue;
        }
        
        const saida = {
          id: Date.now() + Math.random() * 1000,
          loja: loja || "Manual",
          categoria: categoria || "Outros",
          descricao: descricao || categoria || "Sa√≠da",
          valor,
          data: data || new Date().toISOString().split('T')[0],
          recorrente: "N√£o",
          tipoRecorrencia: null,
          pago: pago || "Sim",
          origem: 'multiplas',
          timestamp: new Date()
        };
        
        try {
          if (saida.pago === 'Sim') {
            saidas.unshift(saida);
          } else {
            saidasPendentes.unshift(saida);
          }
          sucessos++;
        } catch (error) {
          console.error('‚ùå Erro sa√≠da m√∫ltipla:', error);
          erros++;
        }
      }
      
      salvarDadosLocal();
      atualizarInterfaceCompleta();
      
      cancelarMultiplasSaidas();
      mostrarMensagemSucesso(`‚úÖ ${sucessos} sa√≠das adicionadas! ${erros > 0 ? `(${erros} erros)` : ''}`);
    }

    function cancelarMultiplasSaidas() {
      const container = document.getElementById("multiplasSaidasContainer");
      if (container) {
        container.style.display = "none";
      }
      
      const listaSaidas = document.getElementById("listaSaidas");
      if (listaSaidas) {
        listaSaidas.innerHTML = "";
      }
      
      multiplasSaidasLista = [];
      contadorMultiplas = 0;
    }
    
    // ============================================================================
    // INTERFACE E ATUALIZA√á√ÉO
    // ============================================================================
    
    function atualizarInterfaceCompleta() {
      try {
        console.log('üîÑ Atualizando interface...');
        
        atualizarCategorias();
        atualizarLojas();
        atualizarTabela();
        atualizarFiltros();
        atualizarDashboard();
        atualizarGraficos();
        
        console.log('‚úÖ Interface atualizada');
      } catch (error) {
        console.error('‚ùå Erro atualizar interface:', error);
      }
    }

    function atualizarCategorias() {
      const select = document.getElementById("categoria");
      if (!select) return;
      
      select.innerHTML = "";
      categorias.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    function atualizarLojas() {
      const select = document.getElementById("loja");
      if (!select) return;
      
      select.innerHTML = "";
      lojas.forEach(loja => {
        const option = document.createElement("option");
        option.value = loja;
        option.textContent = loja;
        select.appendChild(option);
      });
    }

    function atualizarFiltros() {
      // Filtro global
      const filtroGlobal = document.getElementById("filtroLojaGlobal");
      if (filtroGlobal) {
        const valorAtual = filtroGlobal.value;
        filtroGlobal.innerHTML = '<option value="">üìä Todas as lojas (Consolidado)</option>';
        
        lojas.forEach(loja => {
          const option = document.createElement("option");
          option.value = loja;
          option.textContent = loja;
          if (loja === valorAtual) option.selected = true;
          filtroGlobal.appendChild(option);
        });
      }

      // Outros filtros
      const filtroRecorrentes = document.getElementById("filtroLojaRecorrentes");
      if (filtroRecorrentes) {
        const valorAtual = filtroRecorrentes.value;
        filtroRecorrentes.innerHTML = '<option value="">Todas as lojas</option>';
        
        lojas.forEach(loja => {
          const option = document.createElement("option");
          option.value = loja;
          option.textContent = loja;
          if (loja === valorAtual) option.selected = true;
          filtroRecorrentes.appendChild(option);
        });
      }

      const filtroCategoria = document.getElementById("filtroCategoriaRecorrentes");
      if (filtroCategoria) {
        const valorAtual = filtroCategoria.value;
        filtroCategoria.innerHTML = '<option value="">Todos os centros de custo</option>';
        
        categorias.forEach(cat => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          if (cat === valorAtual) option.selected = true;
          filtroCategoria.appendChild(option);
        });
      }
    }

    function atualizarTabela() {
      const tbody = document.getElementById("tabelaSaidas");
      const tbodyAtrasadas = document.getElementById("tabelaAtrasadas");
      const tbodyProximas = document.getElementById("tabelaProximas");
      
      if (!tbody) return;
      
      // Limpar tabelas
      tbody.innerHTML = "";
      if (tbodyAtrasadas) tbodyAtrasadas.innerHTML = "";
      if (tbodyProximas) tbodyProximas.innerHTML = "";
      
      const hoje = new Date();
      const anoMes = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
      
      const saidasPagas = [];
      const saidasAtrasadas = [];
      const saidasProximas = [];
      
      [...saidas, ...saidasPendentes].forEach(s => {
        const dataSaida = new Date(s.data + 'T00:00:00');
        const diffDias = Math.floor((hoje - dataSaida) / (1000 * 60 * 60 * 24));
        
        if (lojaFiltroAtual && s.loja !== lojaFiltroAtual) return;
        
        if (s.pago === 'N√£o' && diffDias > 0) {
          saidasAtrasadas.push({...s, diasAtrasado: diffDias});
        } else if (s.pago === 'N√£o' && diffDias >= -7 && diffDias <= 0) {
          saidasProximas.push({...s, diasRestantes: Math.abs(diffDias)});
        } else if (s.data.substring(0, 7) === anoMes) {
          saidasPagas.push(s);
        }
      });
      
      // Ordenar
      saidasPagas.sort((a, b) => new Date(b.data) - new Date(a.data));
      saidasAtrasadas.sort((a, b) => b.diasAtrasado - a.diasAtrasado);
      saidasProximas.sort((a, b) => a.diasRestantes - b.diasRestantes);
      
      // Preencher tabelas
      preencherTabelaDoMes(tbody, saidasPagas);
      preencherTabelaAtrasadas(tbodyAtrasadas, saidasAtrasadas);
      preencherTabelaProximas(tbodyProximas, saidasProximas);
    }

    function preencherTabelaDoMes(tbody, saidas) {
      saidas.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${s.loja}</strong></td>
          <td>${s.categoria}</td>
          <td>${s.descricao}</td>
          <td><span class="valor-dourado">${formatarMoedaBR(s.valor)}</span></td>
          <td>${new Date(s.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
          <td><span class="badge ${s.recorrente === 'Sim' ? 'bg-info' : 'bg-secondary'}">${s.recorrente}</span></td>
          <td>${s.tipoRecorrencia || '-'}</td>
          <td>
            <span class="badge ${s.pago === 'Sim' ? 'bg-success' : 'bg-warning'}">${s.pago}</span>
            <button class="btn btn-warning btn-sm ms-1" onclick="editarSaida('${s.firestoreId || ''}', ${s.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm ms-1" onclick="excluirSaida('${s.firestoreId || ''}', ${s.id})" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function preencherTabelaAtrasadas(tbody, saidas) {
      if (!tbody) return;
      
      saidas.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${s.loja}</strong></td>
          <td>${s.categoria}</td>
          <td>${s.descricao}</td>
          <td><span class="valor-dourado">${formatarMoedaBR(s.valor)}</span></td>
          <td>${new Date(s.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
          <td><span class="badge bg-danger">${s.diasAtrasado} dias</span></td>
          <td>
            <button class="btn btn-success btn-sm" onclick="marcarComoPago('${s.firestoreId || ''}', ${s.id})" title="Marcar como Pago">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-warning btn-sm ms-1" onclick="editarSaida('${s.firestoreId || ''}', ${s.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm ms-1" onclick="excluirSaida('${s.firestoreId || ''}', ${s.id})" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function preencherTabelaProximas(tbody, saidas) {
      if (!tbody) return;
      
      saidas.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${s.loja}</strong></td>
          <td>${s.categoria}</td>
          <td>${s.descricao}</td>
          <td><span class="valor-dourado">${formatarMoedaBR(s.valor)}</span></td>
          <td>${new Date(s.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
          <td><span class="badge bg-warning">${s.diasRestantes} dias</span></td>
          <td>
            <button class="btn btn-success btn-sm" onclick="marcarComoPago('${s.firestoreId || ''}', ${s.id})" title="Marcar como Pago">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-warning btn-sm ms-1" onclick="editarSaida('${s.firestoreId || ''}', ${s.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm ms-1" onclick="excluirSaida('${s.firestoreId || ''}', ${s.id})" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function atualizarDashboard() {
      const hoje = new Date();
      const anoMes = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
      
      let saidasMes = [...saidas, ...saidasPendentes].filter(s => {
        const saidaAnoMes = s.data.substring(0, 7);
        return saidaAnoMes === anoMes;
      });

      if (lojaFiltroAtual) {
        saidasMes = saidasMes.filter(s => s.loja === lojaFiltroAtual);
      }

      // Atualizar elementos do dashboard
      const totalMes = saidasMes.reduce((sum, s) => sum + s.valor, 0);
      const elementoTotalMes = document.getElementById("totalMes");
      if (elementoTotalMes) {
        elementoTotalMes.textContent = formatarMoedaBR(totalMes);
      }

      const totalRecorrente = saidasMes.filter(s => s.recorrente === 'Sim').reduce((sum, s) => sum + s.valor, 0);
      const elementoTotalRecorrente = document.getElementById("totalRecorrente");
      if (elementoTotalRecorrente) {
        elementoTotalRecorrente.textContent = formatarMoedaBR(totalRecorrente);
      }

      const maiorGasto = saidasMes.length > 0 ? Math.max(...saidasMes.map(s => s.valor)) : 0;
      const elementoMaiorGasto = document.getElementById("maiorGasto");
      if (elementoMaiorGasto) {
        elementoMaiorGasto.textContent = formatarMoedaBR(maiorGasto);
      }

      const categoriaCount = {};
      saidasMes.forEach(s => {
        categoriaCount[s.categoria] = (categoriaCount[s.categoria] || 0) + s.valor;
      });
      
      const categoriaTopo = Object.keys(categoriaCount).length > 0 
        ? Object.keys(categoriaCount).reduce((a, b) => categoriaCount[a] > categoriaCount[b] ? a : b)
        : '-';
      const elementoCategoriaTopo = document.getElementById("categoriaTopo");
      if (elementoCategoriaTopo) {
        elementoCategoriaTopo.textContent = categoriaTopo;
      }

      const elementoTotalSaidas = document.getElementById("totalSaidas");
      if (elementoTotalSaidas) {
        elementoTotalSaidas.textContent = saidasMes.length;
      }
    }

    function atualizarGraficos() {
      try {
        console.log('üìä Atualizando gr√°ficos...');
        
        const hoje = new Date();
        const anoMes = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
        
        let dadosGrafico = [...saidas, ...saidasPendentes].filter(s => {
          const saidaAnoMes = s.data.substring(0, 7);
          return saidaAnoMes === anoMes;
        });

        if (lojaFiltroAtual) {
          dadosGrafico = dadosGrafico.filter(s => s.loja === lojaFiltroAtual);
        }
        
        atualizarGraficoCategoria(dadosGrafico);
        atualizarGraficoTipo(dadosGrafico);
        atualizarGraficoLojas(dadosGrafico);
        
      } catch (error) {
        console.error('‚ùå Erro gr√°ficos:', error);
      }
    }

    function atualizarGraficoCategoria(dados) {
      const ctx = document.getElementById('graficoCategoria');
      if (!ctx) return;
      
      try {
        if (window.chartCategoria) {
          window.chartCategoria.destroy();
        }
        
        const categoriaValues = {};
        dados.forEach(s => {
          categoriaValues[s.categoria] = (categoriaValues[s.categoria] || 0) + s.valor;
        });
        
        const labels = Object.keys(categoriaValues);
        const values = Object.values(categoriaValues);
        
        const cores = [
          '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', 
          '#ef4444', '#06b6d4', '#84cc16', '#f97316',
          '#ec4899', '#6366f1', '#14b8a6', '#eab308'
        ];
        
        window.chartCategoria = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: cores.slice(0, labels.length),
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('‚ùå Erro gr√°fico categoria:', error);
      }
    }

    function atualizarGraficoTipo(dados) {
      const ctx = document.getElementById('graficoTipo');
      if (!ctx) return;
      
      try {
        if (window.chartTipo) {
          window.chartTipo.destroy();
        }
        
        const pago = dados.filter(s => s.pago === 'Sim').reduce((sum, s) => sum + s.valor, 0);
        const pendente = dados.filter(s => s.pago === 'N√£o').reduce((sum, s) => sum + s.valor, 0);
        
        window.chartTipo = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Pago', 'Pendente'],
            datasets: [{
              data: [pago, pendente],
              backgroundColor: ['#10b981', '#f59e0b'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('‚ùå Erro gr√°fico tipo:', error);
      }
    }

    function atualizarGraficoLojas(dados) {
      const ctx = document.getElementById('graficoLojas');
      if (!ctx) return;
      
      try {
        if (window.chartLojas) {
          window.chartLojas.destroy();
        }
        
        const lojaValues = {};
        dados.forEach(s => {
          lojaValues[s.loja] = (lojaValues[s.loja] || 0) + s.valor;
        });
        
        const labels = Object.keys(lojaValues);
        const values = Object.values(lojaValues);
        
        window.chartLojas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Valor Total',
              data: values,
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R$ ' + value.toLocaleString('pt-BR');
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      } catch (error) {
        console.error('‚ùå Erro gr√°fico lojas:', error);
      }
    }
    
    // ============================================================================
    // FILTROS
    // ============================================================================
    
    function aplicarFiltroLoja() {
      const filtro = document.getElementById("filtroLojaGlobal");
      lojaFiltroAtual = filtro ? filtro.value : "";
      atualizarTabela();
      atualizarDashboard();
      atualizarGraficos();
    }

    function toggleTipoRecorrencia() {
      const recorrente = document.getElementById("recorrente");
      const coluna = document.getElementById("colunaTipoRecorrencia");
      
      if (recorrente && coluna) {
        if (recorrente.value === "Sim") {
          coluna.style.display = "block";
        } else {
          coluna.style.display = "none";
          const tipoRecorrencia = document.getElementById("tipoRecorrencia");
          if (tipoRecorrencia) {
            tipoRecorrencia.value = "";
          }
        }
      }
    }

    function filtrarRecorrentesPorFiltros() {
      console.log('üîç Filtros de recorrentes aplicados');
    }

    function limparFiltrosRecorrentes() {
      const filtros = [
        "filtroLojaRecorrentes",
        "filtroAnoRecorrentes", 
        "filtroMesRecorrentes",
        "filtroCategoriaRecorrentes"
      ];
      
      filtros.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
          elemento.value = "";
        }
      });
      
      filtrarRecorrentesPorFiltros();
    }

    function preencherMesesDoAno() {
      console.log('üìÖ Meses do ano preenchidos');
    }
    
    // ============================================================================
    // FUN√á√ïES AUXILIARES
    // ============================================================================
    
    function formatarMoedaBR(valor) {
      return valor.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    function mostrarMensagemSucesso(texto = '‚úÖ Opera√ß√£o realizada!') {
      const mensagem = document.getElementById("mensagemSucesso");
      if (!mensagem) return;
      
      mensagem.textContent = texto;
      mensagem.style.display = "block";
      
      setTimeout(() => {
        mensagem.style.display = "none";
      }, 3000);
    }

    function formatarMoeda(input) {
      let valor = input.value.replace(/\D/g, '');
      
      if (valor === '') {
        input.value = '';
        return;
      }
      
      valor = parseInt(valor);
      const valorFormatado = (valor / 100).toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
      
      input.value = valorFormatado;
    }

    function extrairValorNumerico(valorFormatado) {
      if (!valorFormatado) return 0;
      return parseFloat(valorFormatado.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    }

    function limparFormulario() {
      const campos = ['descricao', 'valor'];
      campos.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (elemento) elemento.value = '';
      });
      
      const dataElement = document.getElementById('data');
      if (dataElement) {
        dataElement.value = new Date().toISOString().split('T')[0];
      }
    }
    
    // ============================================================================
    // BACKUP LOCAL SEGURO
    // ============================================================================
    
    function salvarDadosLocal() {
      try {
        const dadosBackup = {
          categorias,
          lojas, 
          saidas,
          saidasPendentes,
          treinamentosIA,
          versao: '1.0.0',
          ultimoBackup: new Date().toISOString(),
          totalSaidas: saidas.length + saidasPendentes.length
        };
        
        localStorage.setItem('iclubSaidas', JSON.stringify(dadosBackup));
        localStorage.setItem('iclubSaidasBackup', JSON.stringify(dadosBackup));
        
        console.log('üíæ Backup local salvo:', dadosBackup.totalSaidas, 'sa√≠das');
      } catch (error) {
        console.error('‚ùå Erro salvar backup:', error);
      }
    }

    function carregarDadosLocal() {
      try {
        let dadosSalvos = localStorage.getItem('iclubSaidas');
        
        if (!dadosSalvos) {
          dadosSalvos = localStorage.getItem('iclubSaidasBackup');
        }
        
        if (dadosSalvos) {
          const dados = JSON.parse(dadosSalvos);
          
          if (dados.categorias) categorias = dados.categorias;
          if (dados.lojas) lojas = dados.lojas;
          if (dados.saidas) saidas = dados.saidas;
          if (dados.saidasPendentes) saidasPendentes = dados.saidasPendentes;
          if (dados.treinamentosIA) treinamentosIA = dados.treinamentosIA;
          
          console.log('üìÇ Backup local carregado:', dados.totalSaidas || 0, 'sa√≠das');
          console.log('üìÇ √öltimo backup:', dados.ultimoBackup || 'Desconhecido');
          
          return true;
        } else {
          console.log('üìÇ Nenhum backup local encontrado');
          return false;
        }
      } catch (error) {
        console.error('‚ùå Erro carregar backup:', error);
        return false;
      }
    }
    
    // ============================================================================
    // AN√ÅLISE INTELIGENTE (SIMPLIFICADA)
    // ============================================================================
    
    // Vari√°veis globais para an√°lise
    let dadosParaAnalise = [];
    let analiseCompleta = null;

    // Fun√ß√£o principal para abrir an√°lise inteligente
    async function abrirAnaliseInteligente() {
      const modal = document.getElementById('modalAnaliseInteligente');
      const loading = document.getElementById('analiseLoading');
      const resultado = document.getElementById('analiseResultado');
      
      // Mostrar modal e loading
      modal.style.display = 'block';
      loading.style.display = 'block';
      resultado.style.display = 'none';
      
      // Resetar progresso
      document.getElementById('progressoBarra').style.width = '0%';
      
      try {
        // Simular progresso de an√°lise
        await simularProgressoAnalise();
        
        // Executar an√°lise
        const analise = await executarAnaliseInteligente();
        
        // Mostrar resultados
        exibirResultadosAnalise(analise);
        
        loading.style.display = 'none';
        resultado.style.display = 'block';
        
      } catch (error) {
        console.error('‚ùå Erro na an√°lise:', error);
        document.getElementById('analiseLoading').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px;"></i>
            <h4>Erro na An√°lise</h4>
            <p>N√£o foi poss√≠vel processar os dados. Tente novamente.</p>
            <button class="btn-analise-inteligente" onclick="fecharAnaliseInteligente()">Fechar</button>
          </div>
        `;
      }
    }

    function fecharAnaliseInteligente() {
      document.getElementById('modalAnaliseInteligente').style.display = 'none';
    }

    // Simular progresso da an√°lise
    async function simularProgressoAnalise() {
      const etapas = [
        { progresso: 10, texto: 'Carregando dados locais...' },
        { progresso: 25, texto: 'Processando padr√µes de gastos...' },
        { progresso: 45, texto: 'Analisando tend√™ncias temporais...' },
        { progresso: 65, texto: 'Identificando oportunidades...' },
        { progresso: 80, texto: 'Gerando insights inteligentes...' },
        { progresso: 95, texto: 'Finalizando an√°lise...' },
        { progresso: 100, texto: 'An√°lise conclu√≠da!' }
      ];

      for (const etapa of etapas) {
        document.getElementById('progressoBarra').style.width = etapa.progresso + '%';
        document.getElementById('etapaAnalise').textContent = etapa.texto;
        await new Promise(resolve => setTimeout(resolve, 600));
      }
    }

    // Executar an√°lise inteligente
    async function executarAnaliseInteligente() {
      // Coletar dados do sistema
      dadosParaAnalise = await coletarDadosParaAnalise();
      
      // Executar diferentes tipos de an√°lise
      const analise = {
        resumoExecutivo: gerarResumoExecutivo(dadosParaAnalise),
        insights: gerarInsightsPrincipais(dadosParaAnalise)
      };

      analiseCompleta = analise;
      return analise;
    }

    // Coletar dados para an√°lise
    async function coletarDadosParaAnalise() {
      // Usar dados do sistema j√° carregados
      const todasSaidas = [...saidas, ...saidasPendentes];
      
      // Agrupar dados por diferentes dimens√µes
      const dados = {
        saidas: todasSaidas,
        totalSaidas: todasSaidas.length,
        valorTotal: todasSaidas.reduce((sum, s) => sum + (s.valor || 0), 0),
        categorias: agruparPorCategoria(todasSaidas),
        lojas: agruparPorLoja(todasSaidas),
        statusPagamento: agruparPorStatus(todasSaidas)
      };

      return dados;
    }

    // Fun√ß√µes auxiliares de agrupamento
    function agruparPorCategoria(saidas) {
      const grupos = {};
      saidas.forEach(s => {
        if (!grupos[s.categoria]) {
          grupos[s.categoria] = { itens: [], total: 0, count: 0 };
        }
        grupos[s.categoria].itens.push(s);
        grupos[s.categoria].total += s.valor || 0;
        grupos[s.categoria].count++;
      });
      return grupos;
    }

    function agruparPorLoja(saidas) {
      const grupos = {};
      saidas.forEach(s => {
        if (!grupos[s.loja]) {
          grupos[s.loja] = { itens: [], total: 0, count: 0 };
        }
        grupos[s.loja].itens.push(s);
        grupos[s.loja].total += s.valor || 0;
        grupos[s.loja].count++;
      });
      return grupos;
    }

    function agruparPorStatus(saidas) {
      const pagos = saidas.filter(s => s.pago === 'Sim');
      const pendentes = saidas.filter(s => s.pago === 'N√£o');
      
      return {
        pagos: {
          itens: pagos,
          total: pagos.reduce((sum, s) => sum + (s.valor || 0), 0),
          count: pagos.length
        },
        pendentes: {
          itens: pendentes,
          total: pendentes.reduce((sum, s) => sum + (s.valor || 0), 0),
          count: pendentes.length
        }
      };
    }

    // Gerar resumo executivo
    function gerarResumoExecutivo(dados) {
      const ticketMedio = dados.totalSaidas > 0 ? dados.valorTotal / dados.totalSaidas : 0;
      const categoriaTop = Object.keys(dados.categorias).reduce((a, b) => 
        dados.categorias[a].total > dados.categorias[b].total ? a : b, 
        Object.keys(dados.categorias)[0] || 'N/A'
      );
      
      return {
        valorTotal: dados.valorTotal,
        totalSaidas: dados.totalSaidas,
        ticketMedio: ticketMedio,
        categoriaTop: categoriaTop,
        percentualPendente: dados.totalSaidas > 0 ? 
          (dados.statusPagamento.pendentes.count / dados.totalSaidas * 100) : 0
      };
    }

    // Gerar insights principais
    function gerarInsightsPrincipais(dados) {
      const insights = [];
      
      // Insight 1: Categoria dominante
      if (Object.keys(dados.categorias).length > 0) {
        const categoriaTop = Object.entries(dados.categorias)
          .sort(([,a], [,b]) => b.total - a.total)[0];
        
        if (categoriaTop) {
          const [categoria, dadosCategoria] = categoriaTop;
          const percentual = (dadosCategoria.total / dados.valorTotal * 100);
          
          insights.push({
            tipo: 'insight',
            titulo: 'Categoria Dominante',
            valor: percentual.toFixed(1) + '%',
            descricao: `A categoria "${categoria}" representa ${percentual.toFixed(1)}% dos seus gastos totais (${formatarMoedaBR(dadosCategoria.total)}). Essa concentra√ß√£o pode indicar oportunidades de otimiza√ß√£o.`,
            acoes: ['Analisar fornecedores', 'Buscar alternativas', 'Negociar pre√ßos']
          });
        }
      }

      // Insight 2: Status de pagamentos
      if (dados.statusPagamento.pendentes.count > 0) {
        const percentualPendente = (dados.statusPagamento.pendentes.count / dados.totalSaidas * 100);
        
        if (percentualPendente > 30) {
          insights.push({
            tipo: 'alerta',
            titulo: 'Alto Volume de Pend√™ncias',
            valor: dados.statusPagamento.pendentes.count + ' sa√≠das',
            descricao: `Voc√™ tem ${dados.statusPagamento.pendentes.count} sa√≠das pendentes (${percentualPendente.toFixed(1)}%), totalizando ${formatarMoedaBR(dados.statusPagamento.pendentes.total)}. Isso pode impactar seu fluxo de caixa.`,
            acoes: ['Priorizar pagamentos', 'Renegociar prazos', 'Organizar cronograma']
          });
        }
      }

      // Insight 3: Distribui√ß√£o por lojas
      if (Object.keys(dados.lojas).length > 1) {
        const lojasOrdenadas = Object.entries(dados.lojas)
          .sort(([,a], [,b]) => b.total - a.total);
        
        const lojaTop = lojasOrdenadas[0];
        const percentualLojaTop = (lojaTop[1].total / dados.valorTotal * 100);
        
        insights.push({
          tipo: 'tendencia',
          titulo: 'Loja com Maior Movimento',
          valor: percentualLojaTop.toFixed(1) + '%',
          descricao: `A "${lojaTop[0]}" concentra ${percentualLojaTop.toFixed(1)}% dos gastos (${formatarMoedaBR(lojaTop[1].total)}). Verifique se essa distribui√ß√£o est√° alinhada com o planejamento.`,
          acoes: ['Revisar distribui√ß√£o', 'Balancear investimentos', 'Analisar rentabilidade']
        });
      }

      return insights;
    }

    // Exibir resultados da an√°lise
    function exibirResultadosAnalise(analise) {
      const container = document.getElementById('analiseResultado');
      
      let html = `
        <div class="resumo-executivo">
          <h4 class="resumo-titulo">üìä Resumo Executivo</h4>
          <p>An√°lise completa dos dados do sistema iClub</p>
          <div class="resumo-stats">
            <div class="resumo-stat">
              <div class="resumo-stat-valor">${formatarMoedaBR(analise.resumoExecutivo.valorTotal)}</div>
              <div class="resumo-stat-label">Valor Total</div>
            </div>
            <div class="resumo-stat">
              <div class="resumo-stat-valor">${analise.resumoExecutivo.totalSaidas}</div>
              <div class="resumo-stat-label">Total Sa√≠das</div>
            </div>
            <div class="resumo-stat">
              <div class="resumo-stat-valor">${formatarMoedaBR(analise.resumoExecutivo.ticketMedio)}</div>
              <div class="resumo-stat-label">Ticket M√©dio</div>
            </div>
            <div class="resumo-stat">
              <div class="resumo-stat-valor">${analise.resumoExecutivo.categoriaTop}</div>
              <div class="resumo-stat-label">Categoria Top</div>
            </div>
          </div>
        </div>
      `;

      // Adicionar insights
      analise.insights.forEach(insight => {
        html += `
          <div class="insight-card tipo-${insight.tipo}">
            <div class="insight-header">
              <div class="insight-icon ${insight.tipo}">
                <i class="fas fa-${insight.tipo === 'alerta' ? 'exclamation-triangle' : insight.tipo === 'tendencia' ? 'chart-line' : 'lightbulb'}"></i>
              </div>
              <div>
                <h6 class="insight-titulo">${insight.titulo}</h6>
                <p class="insight-valor">${insight.valor}</p>
              </div>
            </div>
            <div class="insight-descricao">
              ${insight.descricao}
            </div>
            <div class="insight-acoes">
              ${insight.acoes.map(acao => `<span class="insight-acao">${acao}</span>`).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }
    
    // ============================================================================
    // INICIALIZA√á√ÉO PRINCIPAL
    // ============================================================================
    
    window.addEventListener('load', async () => {
      try {
        console.log('üöÄ Iniciando aplica√ß√£o iClub...');
        
        // Configurar data padr√£o
        const dataElement = document.getElementById('data');
        if (dataElement && !dataElement.value) {
          dataElement.value = new Date().toISOString().split('T')[0];
        }
        
        // Event listener para Enter no chat
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
          chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              enviarMensagemChat();
            }
          });
        }
        
        // Carregar dados locais
        const backupOK = carregarDadosLocal();
        if (backupOK) {
          console.log('‚úÖ Dados carregados do backup local');
        }
        
        // Atualizar interface
        atualizarInterfaceCompleta();
        
        // Confirmar carregamento
        const totalSaidas = saidas.length + saidasPendentes.length;
        console.log('‚úÖ Sistema carregado:', totalSaidas, 'sa√≠das total');
        
        if (totalSaidas > 0) {
          mostrarMensagemSucesso(`‚úÖ Sistema carregado! ${totalSaidas} sa√≠das encontradas.`);
        } else {
          mostrarMensagemSucesso('‚úÖ Sistema carregado! Pronto para uso.');
        }
        
      } catch (error) {
        console.error('‚ùå Erro cr√≠tico:', error);
        mostrarMensagemSucesso('‚ùå Erro ao carregar. Verifique o console.');
      }
    });

    // Log inicial
    console.log('‚úÖ Sistema iClub carregado com sucesso!');
    console.log('üß† IA integrada com treinamento personalizado');
    console.log('üìä An√°lise inteligente dispon√≠vel');
  </script>
    
    // Vari√°veis globais para an√°lise
    let dadosParaAnalise = [];
    let analiseCompleta = null;

    // Fun√ß√£o principal para abrir an√°lise inteligente
    async function abrirAnaliseInteligente() {
      const modal = document.getElementById('modalAnaliseInteligente');
      const loading = document.getElementById('analiseLoading');
      const resultado = document.getElementById('analiseResultado');
      
      // Mostrar modal e loading
      modal.style.display = 'block';
      loading.style.display = 'block';
      resultado.style.display = 'none';
      
      // Resetar progresso
      document.getElementById('progressoBarra').style.width = '0%';
      
      try {
        // Simular progresso de an√°lise
        await simularProgressoAnalise();
        
        // Executar an√°lise
        const analise = await executarAnaliseInteligente();
        
        // Mostrar resultados
        exibirResultadosAnalise(analise);
        
        loading.style.display = 'none';
        resultado.style.display = 'block';
        
      } catch (error) {
        console.error('‚ùå Erro na an√°lise:', error);
        document.getElementById('analiseLoading').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px;"></i>
            <h4>Erro na An√°lise</h4>
            <p>N√£o foi poss√≠vel processar os dados. Tente novamente.</p>
            <button class="btn-analise-inteligente" onclick="fecharAnaliseInteligente()">Fechar</button>
          </div>
        `;
      }
    }

    function fecharAnaliseInteligente() {
      document.getElementById('modalAnaliseInteligente').style.display = 'none';
    }

    // Simular progresso da an√°lise
    async function simularProgressoAnalise() {
      const etapas = [
        { progresso: 10, texto: 'Carregando dados do Firebase...' },
        { progresso: 25, texto: 'Processando padr√µes de gastos...' },
        { progresso: 45, texto: 'Analisando tend√™ncias temporais...' },
        { progresso: 65, texto: 'Identificando oportunidades...' },
        { progresso: 80, texto: 'Gerando insights inteligentes...' },
        { progresso: 95, texto: 'Finalizando an√°lise...' },
        { progresso: 100, texto: 'An√°lise conclu√≠da!' }
      ];

      for (const etapa of etapas) {
        document.getElementById('progressoBarra').style.width = etapa.progresso + '%';
        document.getElementById('etapaAnalise').textContent = etapa.texto;
        await new Promise(resolve => setTimeout(resolve, 800));
      }
    }

    // Executar an√°lise inteligente
    async function executarAnaliseInteligente() {
      // Coletar dados do sistema
      dadosParaAnalise = await coletarDadosParaAnalise();
      
      // Executar diferentes tipos de an√°lise
      const analise = {
        resumoExecutivo: gerarResumoExecutivo(dadosParaAnalise),
        tendencias: analisarTendencias(dadosParaAnalise),
        alertas: identificarAlertas(dadosParaAnalise),
        oportunidades: identificarOportunidades(dadosParaAnalise),
        insights: gerarInsights(dadosParaAnalise),
        previsoes: gerarPrevisoes(dadosParaAnalise)
      };

      analiseCompleta = analise;
      return analise;
    }

    // Coletar dados para an√°lise
    async function coletarDadosParaAnalise() {
      // Usar dados do sistema j√° carregados
      const todasSaidas = [...(window.saidas || []), ...(window.saidasPendentes || [])];
      
      // Agrupar dados por diferentes dimens√µes
      const dados = {
        saidas: todasSaidas,
        totalSaidas: todasSaidas.length,
        valorTotal: todasSaidas.reduce((sum, s) => sum + (s.valor || 0), 0),
        categorias: agruparPorCategoria(todasSaidas),
        lojas: agruparPorLoja(todasSaidas),
        meses: agruparPorMes(todasSaidas),
        statusPagamento: agruparPorStatus(todasSaidas),
        recorrentes: todasSaidas.filter(s => s.recorrente === 'Sim'),
        periodo: calcularPeriodoAnalise(todasSaidas)
      };

      return dados;
    }

    // Fun√ß√µes auxiliares de agrupamento
    function agruparPorCategoria(saidas) {
      const grupos = {};
      saidas.forEach(s => {
        if (!grupos[s.categoria]) {
          grupos[s.categoria] = { itens: [], total: 0, count: 0 };
        }
        grupos[s.categoria].itens.push(s);
        grupos[s.categoria].total += s.valor || 0;
        grupos[s.categoria].count++;
      });
      return grupos;
    }

    function agruparPorLoja(saidas) {
      const grupos = {};
      saidas.forEach(s => {
        if (!grupos[s.loja]) {
          grupos[s.loja] = { itens: [], total: 0, count: 0 };
        }
        grupos[s.loja].itens.push(s);
        grupos[s.loja].total += s.valor || 0;
        grupos[s.loja].count++;
      });
      return grupos;
    }

    function agruparPorMes(saidas) {
      const grupos = {};
      saidas.forEach(s => {
        const mes = s.data?.substring(0, 7) || 'indefinido';
        if (!grupos[mes]) {
          grupos[mes] = { itens: [], total: 0, count: 0 };
        }
        grupos[mes].itens.push(s);
        grupos[mes].total += s.valor || 0;
        grupos[mes].count++;
      });
      return grupos;
    }

    function agruparPorStatus(saidas) {
      const pagos = saidas.filter(s => s.pago === 'Sim');
      const pendentes = saidas.filter(s => s.pago === 'N√£o');
      
      return {
        pagos: {
          itens: pagos,
          total: pagos.reduce((sum, s) => sum + (s.valor || 0), 0),
          count: pagos.length
        },
        pendentes: {
          itens: pendentes,
          total: pendentes.reduce((sum, s) => sum + (s.valor || 0), 0),
          count: pendentes.length
        }
      };
    }

    function calcularPeriodoAnalise(saidas) {
      if (saidas.length === 0) return null;
      
      const datas = saidas.map(s => new Date(s.data)).filter(d => !isNaN(d));
      if (datas.length === 0) return null;
      
      const inicio = new Date(Math.min(...datas));
      const fim = new Date(Math.max(...datas));
      const diasPeriodo = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24));
      
      return { inicio, fim, diasPeriodo };
    }

    // Gerar resumo executivo
    function gerarResumoExecutivo(dados) {
      const ticketMedio = dados.totalSaidas > 0 ? dados.valorTotal / dados.totalSaidas : 0;
      const categoriaTop = Object.keys(dados.categorias).reduce((a, b) => 
        dados.categorias[a].total > dados.categorias[b].total ? a : b, 
        Object.keys(dados.categorias)[0] || 'N/A'
      );
      
      return {
        valorTotal: dados.valorTotal,
        totalSaidas: dados.totalSaidas,
        ticketMedio: ticketMedio,
        categoriaTop: categoriaTop,
        percentualPendente: dados.totalSaidas > 0 ? 
          (dados.statusPagamento.pendentes.count / dados.totalSaidas * 100) : 0,
        periodo: dados.periodo
      };
    }

    // Analisar tend√™ncias
    function analisarTendencias(dados) {
      const tendencias = [];
      
      // Tend√™ncia de crescimento mensal
      const mesesOrdenados = Object.keys(dados.meses).sort();
      if (mesesOrdenados.length >= 2) {
        const ultimoMes = dados.meses[mesesOrdenados[mesesOrdenados.length - 1]];
        const penultimoMes = dados.meses[mesesOrdenados[mesesOrdenados.length - 2]];
        
        const crescimento = ((ultimoMes.total - penultimoMes.total) / penultimoMes.total) * 100;
        
        tendencias.push({
          tipo: 'tendencia',
          titulo: 'Tend√™ncia de Gastos Mensais',
          valor: Math.abs(crescimento).toFixed(1) + '%',
          descricao: crescimento > 0 ? 
            `Seus gastos aumentaram ${crescimento.toFixed(1)}% no √∫ltimo m√™s. Considere revisar os gastos em categorias n√£o essenciais.` :
            `Seus gastos diminu√≠ram ${Math.abs(crescimento).toFixed(1)}% no √∫ltimo m√™s. Parab√©ns pelo controle financeiro!`,
          acoes: crescimento > 0 ? ['Revisar or√ßamento', 'Identificar gastos extras'] : ['Manter disciplina', 'Investir economia']
        });
      }

      // Categoria em alta
      const categoriaEmAlta = Object.entries(dados.categorias)
        .sort(([,a], [,b]) => b.total - a.total)[0];
      
      if (categoriaEmAlta) {
        const [categoria, dadosCategoria] = categoriaEmAlta;
        const percentual = (dadosCategoria.total / dados.valorTotal * 100);
        
        tendencias.push({
          tipo: 'tendencia',
          titulo: 'Categoria Dominante',
          valor: percentual.toFixed(1) + '%',
          descricao: `A categoria "${categoria}" representa ${percentual.toFixed(1)}% dos seus gastos totais. Essa concentra√ß√£o pode indicar oportunidades de otimiza√ß√£o.`,
          acoes: ['Analisar fornecedores', 'Buscar alternativas', 'Negociar pre√ßos']
        });
      }

      return tendencias;
    }

    // Identificar alertas
    function identificarAlertas(dados) {
      const alertas = [];
      
      // Alerta: Muitas sa√≠das pendentes
      if (dados.statusPagamento.pendentes.count > dados.totalSaidas * 0.3) {
        alertas.push({
          tipo: 'alerta',
          titulo: 'Alto Volume de Pend√™ncias',
          valor: dados.statusPagamento.pendentes.count + ' sa√≠das',
          descricao: `Voc√™ tem ${dados.statusPagamento.pendentes.count} sa√≠das pendentes, representando ${formatarMoedaBR(dados.statusPagamento.pendentes.total)}. Isso pode impactar seu fluxo de caixa.`,
          acoes: ['Priorizar pagamentos', 'Renegoc